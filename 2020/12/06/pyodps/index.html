<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">






  
  
  <link rel="stylesheet" media="all" href="/xiangyang/lib/Han/dist/han.min.css?v=3.3">




<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/xiangyang/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/xiangyang/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/xiangyang/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/xiangyang/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/xiangyang/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/xiangyang/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/xiangyang/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="阿里云,Python," />










<meta name="description" content="在工作中较多的使用到了阿里云提供的pyodps。相对于其他的大数据python api来说，似乎阿里云的PyODPS很好使用。类似于Pandas，在学习上是很容易的。这里整理和收集了阿里云官方提供的案例。在后续的时间里，会陆续的整理一些在实际操作中的案例。">
<meta property="og:type" content="article">
<meta property="og:title" content="PyODPS">
<meta property="og:url" content="https://youxiangyang.github.io/2020/12/06/pyodps/index.html">
<meta property="og:site_name" content="Udata">
<meta property="og:description" content="在工作中较多的使用到了阿里云提供的pyodps。相对于其他的大数据python api来说，似乎阿里云的PyODPS很好使用。类似于Pandas，在学习上是很容易的。这里整理和收集了阿里云官方提供的案例。在后续的时间里，会陆续的整理一些在实际操作中的案例。">
<meta property="og:updated_time" content="2019-11-11T14:36:20.484Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="PyODPS">
<meta name="twitter:description" content="在工作中较多的使用到了阿里云提供的pyodps。相对于其他的大数据python api来说，似乎阿里云的PyODPS很好使用。类似于Pandas，在学习上是很容易的。这里整理和收集了阿里云官方提供的案例。在后续的时间里，会陆续的整理一些在实际操作中的案例。">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/xiangyang/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://youxiangyang.github.io/2020/12/06/pyodps/"/>





  <title>PyODPS | Udata</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/xiangyang/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Udata</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">富强 民主 文明 和谐 自由 平等 公正 法治 爱国 敬业 诚信 友善</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/xiangyang/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/xiangyang/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/xiangyang/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/xiangyang/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/xiangyang/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://youxiangyang.github.io/xiangyang/2020/12/06/pyodps/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="xiangyang">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/xiangyang/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Udata">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">PyODPS</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-12-06T12:03:39+08:00">
                2020-12-06
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/xiangyang/categories/阿里云/" itemprop="url" rel="index">
                    <span itemprop="name">阿里云</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body han-init-context" itemprop="articleBody">

      
      

      
        <p>在工作中较多的使用到了阿里云提供的pyodps。相对于其他的大数据python api来说，似乎阿里云的PyODPS很好使用。类似于Pandas，在学习上是很容易的。这里整理和收集了阿里云官方提供的案例。在后续的时间里，会陆续的整理一些在实际操作中的案例。<br><a id="more"></a> </p>
<h1 id="聚合"><a href="#聚合" class="headerlink" title="聚合"></a>聚合</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> odps.df <span class="keyword">import</span> DataFrame</div><div class="line"><span class="keyword">from</span> odps.df <span class="keyword">import</span> Delay</div><div class="line"><span class="keyword">from</span> odps.df <span class="keyword">import</span> Scalar</div><div class="line"><span class="keyword">from</span> odps.df <span class="keyword">import</span> agg</div><div class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</div><div class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</div><div class="line">iris = DataFrame(o.get_table(<span class="string">'pyodps_iris'</span>))</div><div class="line"></div><div class="line"><span class="comment">#describe函数,查看DataFrame里数字列的数量、最大值、最小值、平均值以及标准差。</span></div><div class="line"><span class="keyword">print</span> iris.describe().execute()</div><div class="line"></div><div class="line"><span class="comment">#单列聚合操作。</span></div><div class="line"><span class="keyword">print</span> iris.sepallength.max().execute()</div><div class="line"></div><div class="line"><span class="comment">#消除重复列的聚合。</span></div><div class="line"><span class="keyword">print</span> iris.name.unique().cat(sep=<span class="string">','</span>).execute()</div><div class="line"></div><div class="line"><span class="comment">#统计总行数。</span></div><div class="line"><span class="keyword">print</span> iris.count().execute()</div><div class="line"></div><div class="line"><span class="comment">#分组聚合。</span></div><div class="line"><span class="keyword">print</span> iris.groupby(<span class="string">'name'</span>).agg(iris.sepallength.max(),smin=iris.sepallength.min()).head()</div><div class="line"><span class="keyword">print</span> iris.groupby(<span class="string">'name'</span>).agg(count=iris.name.count()).sort(<span class="string">'count'</span>, ascending=<span class="keyword">False</span>).head(<span class="number">5</span>)</div><div class="line"><span class="keyword">print</span> iris.groupby(<span class="string">'name'</span>).petallength.sum().head()</div><div class="line"><span class="keyword">print</span> iris.groupby(<span class="string">'name'</span>).agg(iris.petallength.notnull().sum()).head()</div><div class="line"><span class="keyword">print</span> iris.groupby(Scalar(<span class="number">1</span>)).petallength.sum().head()</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">#自定义聚合,对应单列。</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Agg</span><span class="params">(object)</span>:</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">buffer</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> [<span class="number">0.0</span>, <span class="number">0</span>]</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, buffer, val)</span>:</span></div><div class="line">        buffer[<span class="number">0</span>] += val</div><div class="line">        buffer[<span class="number">1</span>] += <span class="number">1</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">merge</span><span class="params">(self, buffer, pbuffer)</span>:</span></div><div class="line">        buffer[<span class="number">0</span>] += pbuffer[<span class="number">0</span>]</div><div class="line">        buffer[<span class="number">1</span>] += pbuffer[<span class="number">1</span>]</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getvalue</span><span class="params">(self, buffer)</span>:</span></div><div class="line">        <span class="keyword">if</span> buffer[<span class="number">1</span>] == <span class="number">0</span>:</div><div class="line">            <span class="keyword">return</span> <span class="number">0.0</span></div><div class="line">        <span class="keyword">return</span> buffer[<span class="number">0</span>] / buffer[<span class="number">1</span>]</div><div class="line"></div><div class="line"><span class="keyword">print</span> iris.sepalwidth.agg(Agg).execute()</div><div class="line"></div><div class="line"><span class="comment">#自定义聚合,对应双列。</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Agg2</span><span class="params">(object)</span>:</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">buffer</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> [<span class="number">0.0</span>, <span class="number">0.0</span>]</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, buffer, val1, val2)</span>:</span></div><div class="line">        buffer[<span class="number">0</span>] += val1</div><div class="line">        buffer[<span class="number">1</span>] += val2</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">merge</span><span class="params">(self, buffer, pbuffer)</span>:</span></div><div class="line">        buffer[<span class="number">0</span>] += pbuffer[<span class="number">0</span>]</div><div class="line">        buffer[<span class="number">1</span>] += pbuffer[<span class="number">1</span>]</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">getvalue</span><span class="params">(self, buffer)</span>:</span></div><div class="line">        <span class="keyword">if</span> buffer[<span class="number">1</span>] == <span class="number">0</span>:</div><div class="line">            <span class="keyword">return</span> <span class="number">0.0</span></div><div class="line">        <span class="keyword">return</span> buffer[<span class="number">0</span>] - buffer[<span class="number">1</span>]</div><div class="line"></div><div class="line">to_agg = agg([iris.sepalwidth, iris.sepallength], Agg2, rtype=<span class="string">'float'</span>)  <span class="comment"># 对两列调用自定义聚合。</span></div><div class="line"><span class="keyword">print</span> iris.groupby(<span class="string">'name'</span>).agg(val=to_agg).execute()</div><div class="line"></div><div class="line"><span class="comment">#HyperLogLog计数。</span></div><div class="line"></div><div class="line">df5 = DataFrame(pd.DataFrame(&#123;<span class="string">'a'</span>: np.random.randint(<span class="number">100000</span>, size=<span class="number">100000</span>)&#125;))</div><div class="line"><span class="keyword">print</span> df5.a.hll_count().execute()</div></pre></td></tr></table></figure>
<h1 id="条件过滤"><a href="#条件过滤" class="headerlink" title="条件过滤"></a>条件过滤</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> sys</div><div class="line">reload(sys)</div><div class="line"><span class="comment">#修改系统默认编码。</span></div><div class="line">sys.setdefaultencoding(<span class="string">'utf8'</span>)</div><div class="line"></div><div class="line">iris = DataFrame(o.get_table(<span class="string">'pyodps_iris'</span>))</div><div class="line"><span class="comment">#方法一：使用条件方式输出。</span></div><div class="line"><span class="keyword">with</span> o.execute_sql(<span class="string">'select * from pyodps_iris WHERE sepallength &gt; 5 '</span>).open_reader() <span class="keyword">as</span> reader4:</div><div class="line">    <span class="keyword">print</span> reader4.raw</div><div class="line">    <span class="keyword">for</span> record <span class="keyword">in</span> reader4:</div><div class="line">        <span class="keyword">print</span> record[<span class="string">"sepallength"</span>],record[<span class="string">"sepalwidth"</span>],record[<span class="string">"petallength"</span>],record[<span class="string">"petalwidth"</span>],record[<span class="string">"name"</span>]</div><div class="line"></div><div class="line"><span class="comment">#方法二：使用ODPS的DataFrame的过滤条件得出数据结果。</span></div><div class="line"><span class="keyword">print</span> iris[iris.sepallength &gt; <span class="number">5</span>].head(<span class="number">5</span>)</div><div class="line"></div><div class="line"><span class="comment">#方法三：使用query的方式输出。</span></div><div class="line"><span class="keyword">print</span> iris.query(<span class="string">"(sepallength &lt; 5) and (petallength &gt; 1.5)"</span>).head(<span class="number">5</span>)</div></pre></td></tr></table></figure>
<h1 id="查看分区"><a href="#查看分区" class="headerlink" title="查看分区"></a>查看分区</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> sys</div><div class="line"><span class="keyword">from</span> odps <span class="keyword">import</span> ODPS</div><div class="line">reload(sys)</div><div class="line">print(<span class="string">'dt='</span> + args[<span class="string">'dt'</span>])</div><div class="line"><span class="comment">#修改系统默认编码。</span></div><div class="line">sys.setdefaultencoding(<span class="string">'utf8'</span>)</div><div class="line"><span class="comment">#个人信息凭证。</span></div><div class="line">t = o.get_table(<span class="string">'user_detail'</span>)</div><div class="line"><span class="comment">#获取分区表。</span></div><div class="line"><span class="keyword">print</span> t.exist_partition(<span class="string">'dt=20190715,region=beijing'</span>)</div><div class="line"><span class="comment">#查看所有分区。</span></div><div class="line"><span class="keyword">for</span> partition <span class="keyword">in</span> t.partitions:</div><div class="line">    <span class="keyword">print</span> partition.name</div><div class="line"><span class="comment">#您可以通过以下三种方式查询分区表数据。</span></div><div class="line"><span class="comment">#第一种方式如下。</span></div><div class="line"><span class="keyword">with</span> t.open_reader(partition=<span class="string">'dt=20190715,region=beijing'</span>) <span class="keyword">as</span> reader1:</div><div class="line">    count = reader1.count</div><div class="line">print(<span class="string">"第一种方式查询分区表数据："</span>)</div><div class="line"><span class="keyword">for</span> record <span class="keyword">in</span> reader1:</div><div class="line">    <span class="keyword">print</span> record[<span class="number">0</span>],record[<span class="number">1</span>],record[<span class="number">2</span>]</div><div class="line"><span class="comment">#第二种方式如下。</span></div><div class="line">print(<span class="string">"第二种方式查询分区表数据："</span>)</div><div class="line">reader2 = t.open_reader(partition=<span class="string">'dt=20190715,region=beijing'</span>)</div><div class="line"><span class="keyword">for</span> record <span class="keyword">in</span> reader2:</div><div class="line">    <span class="keyword">print</span> record[<span class="string">"userid"</span>],record[<span class="string">"job"</span>],record[<span class="string">"education"</span>]</div><div class="line"><span class="comment">#第三种方式如下。</span></div><div class="line">print(<span class="string">"第三种方式查询分表数据："</span>)</div><div class="line"><span class="keyword">for</span> record <span class="keyword">in</span> o.read_table(<span class="string">'user_detail'</span>, partition=<span class="string">'dt=20190715,region=beijing'</span>):</div><div class="line">    <span class="keyword">print</span> record[<span class="string">"userid"</span>],record[<span class="string">"job"</span>],record[<span class="string">"education"</span>]</div></pre></td></tr></table></figure>
<h1 id="查看一级分区"><a href="#查看一级分区" class="headerlink" title="查看一级分区"></a>查看一级分区</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> sys</div><div class="line">reload(sys)</div><div class="line"><span class="comment">#修改系统默认编码。</span></div><div class="line">sys.setdefaultencoding(<span class="string">'utf8'</span>)</div><div class="line"></div><div class="line"><span class="comment">#异步方式读取一级分区。</span></div><div class="line">instance = o.run_sql(<span class="string">'select * from user_detail WHERE dt=\'20190715\''</span>)</div><div class="line">instance.wait_for_success()</div><div class="line"><span class="keyword">for</span> record <span class="keyword">in</span> instance.open_reader():</div><div class="line">    <span class="keyword">print</span> record[<span class="string">"userid"</span>],record[<span class="string">"job"</span>],record[<span class="string">"education"</span>]</div><div class="line"></div><div class="line"><span class="comment">#同步方式读取一级分区。</span></div><div class="line"><span class="keyword">with</span> o.execute_sql(<span class="string">'select * from user_detail WHERE dt=\'20190715\''</span>).open_reader() <span class="keyword">as</span> reader4:</div><div class="line">    <span class="keyword">print</span> reader4.raw</div><div class="line">    <span class="keyword">for</span> record <span class="keyword">in</span> reader4:</div><div class="line">        <span class="keyword">print</span> record[<span class="string">"userid"</span>],record[<span class="string">"job"</span>],record[<span class="string">"education"</span>]</div><div class="line"></div><div class="line"><span class="comment">#使用ODPS的DataFrame获取一级分区。</span></div><div class="line">pt_df = DataFrame(o.get_table(<span class="string">'user_detail'</span>).get_partition(<span class="string">'dt=20190715'</span>))</div><div class="line"><span class="keyword">print</span> pt_df.head(<span class="number">10</span>)</div></pre></td></tr></table></figure>
<h1 id="sequence操作"><a href="#sequence操作" class="headerlink" title="sequence操作"></a>sequence操作</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> odps <span class="keyword">import</span> DataFrame</div><div class="line">iris = DataFrame(o.get_table(<span class="string">'pyodps_iris'</span>))</div><div class="line"></div><div class="line"><span class="comment">#获取列。</span></div><div class="line"><span class="keyword">print</span> iris.sepallength.head(<span class="number">5</span>)</div><div class="line"></div><div class="line"><span class="keyword">print</span> iris[<span class="string">'sepallength'</span>].head(<span class="number">5</span>)</div><div class="line"></div><div class="line"><span class="comment">#查看列的类型。</span></div><div class="line"><span class="keyword">print</span> iris.sepallength.dtype</div><div class="line"></div><div class="line"><span class="comment">#修改列的类型。</span></div><div class="line">iris.sepallength.astype(<span class="string">'int'</span>)</div><div class="line"></div><div class="line"><span class="comment">#计算。</span></div><div class="line"><span class="keyword">print</span> iris.groupby(<span class="string">'name'</span>).sepallength.max().head(<span class="number">5</span>)</div><div class="line"></div><div class="line"><span class="keyword">print</span> iris.sepallength.max()</div><div class="line"></div><div class="line"><span class="comment">#重命名列。</span></div><div class="line"><span class="keyword">print</span> iris.sepalwidth.rename(<span class="string">'speal_width'</span>).head(<span class="number">5</span>)</div><div class="line"></div><div class="line"><span class="comment">#简单的列变化。</span></div><div class="line"><span class="keyword">print</span> (iris.sepallength + iris.sepalwidth).rename(<span class="string">'sum_sepal'</span>).head(<span class="number">5</span>)</div><div class="line"></div><div class="line"><span class="keyword">from</span> odps <span class="keyword">import</span> options</div><div class="line"><span class="keyword">from</span> odps <span class="keyword">import</span> DataFrame</div><div class="line"></div><div class="line"><span class="comment">#查看运行时的instance的logview。</span></div><div class="line">options.verbose = <span class="keyword">True</span></div><div class="line">iris = DataFrame(o.get_table(<span class="string">'pyodps_iris'</span>))</div><div class="line">iris[iris.sepallength &lt; <span class="number">5</span>].exclude(<span class="string">'sepallength'</span>)[:<span class="number">5</span>].execute()</div><div class="line"></div><div class="line">my_logs = []</div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">my_loggers</span><span class="params">(x)</span>:</span></div><div class="line">    my_logs.append(x)</div><div class="line"></div><div class="line">options.verbose_log = my_loggers</div><div class="line"></div><div class="line">iris[iris.sepallength &lt; <span class="number">5</span>].exclude(<span class="string">'sepallength'</span>)[:<span class="number">5</span>].execute()</div><div class="line"></div><div class="line">print(my_logs)</div><div class="line"></div><div class="line"><span class="comment">#缓存中间Collection结果。</span></div><div class="line">cached = iris[iris.sepalwidth &lt; <span class="number">3.5</span>].cache()</div><div class="line"><span class="keyword">print</span> cached.head(<span class="number">3</span>)</div><div class="line"></div><div class="line"><span class="comment">#异步和并行执行。</span></div><div class="line"><span class="keyword">from</span> odps.df <span class="keyword">import</span> Delay</div><div class="line">delay = Delay() <span class="comment">#创建Delay对象。</span></div><div class="line">df = iris[iris.sepalwidth &lt; <span class="number">5</span>].cache()  <span class="comment">#有一个共同的依赖。</span></div><div class="line">future1 = df.sepalwidth.sum().execute(delay=delay) <span class="comment">#立即返回future对象，此时并没有执行。</span></div><div class="line">future2 = df.sepalwidth.mean().execute(delay=delay)</div><div class="line">future3 = df.sepalwidth.max().execute(delay=delay)</div><div class="line"></div><div class="line">delay.execute(n_parallel=<span class="number">3</span>)</div><div class="line"></div><div class="line"><span class="keyword">print</span> future1.result()</div><div class="line"><span class="keyword">print</span> future2.result()</div><div class="line"><span class="keyword">print</span> future3.result()</div></pre></td></tr></table></figure>
<h1 id="列运算"><a href="#列运算" class="headerlink" title="列运算"></a>列运算</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> odps <span class="keyword">import</span> DataFrame</div><div class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</div><div class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</div><div class="line"></div><div class="line">iris = DataFrame(o.get_table(<span class="string">'pyodps_iris'</span>))</div><div class="line"></div><div class="line"><span class="comment">#判断是否为null。</span></div><div class="line"><span class="keyword">print</span> iris.sepallength.isnull().head(<span class="number">5</span>)</div><div class="line"></div><div class="line"><span class="comment">#逻辑判断。</span></div><div class="line"><span class="keyword">print</span> (iris.sepallength &gt; <span class="number">5</span>).ifelse(<span class="string">'gt5'</span>,<span class="string">'lte5'</span>).rename(<span class="string">'cmp5'</span>).head(<span class="number">5</span>)</div><div class="line"></div><div class="line"><span class="comment">#多条件判断。</span></div><div class="line"><span class="keyword">print</span> iris.sepallength.switch(<span class="number">4.9</span>,<span class="string">'eq4.9'</span>,<span class="number">5.0</span>,<span class="string">'eq5.0'</span>,default=<span class="string">'noeq'</span>).rename(<span class="string">'equalness'</span>).head(<span class="number">5</span>)</div><div class="line"><span class="keyword">from</span> odps.df <span class="keyword">import</span> switch</div><div class="line"><span class="keyword">print</span> switch(iris.sepallength == <span class="number">4.9</span>,<span class="string">'eq4.9'</span>,iris.sepallength == <span class="number">5.0</span>,<span class="string">'eq5.0'</span>,default=<span class="string">'noeq'</span>).rename(<span class="string">'equalness'</span>).head(<span class="number">5</span>)</div><div class="line"></div><div class="line"><span class="comment">#修该数据集某一列的一部分值。</span></div><div class="line">iris[iris.sepallength &gt; <span class="number">5</span>,<span class="string">'cmp5'</span>] = <span class="string">'gt5'</span></div><div class="line">iris[iris.sepallength &lt;=<span class="number">5</span>,<span class="string">'cmp5'</span>] = <span class="string">'lte5'</span></div><div class="line"><span class="keyword">print</span> iris.head(<span class="number">5</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">#数学计算。</span></div><div class="line"><span class="keyword">print</span> (iris.sepallength * <span class="number">10</span>).log().head(<span class="number">5</span>)</div><div class="line">fields = [iris.sepallength,(iris.sepallength /<span class="number">2</span>).rename(<span class="string">'sepallength/2'</span>),(iris.sepallength ** <span class="number">2</span>).rename(<span class="string">'sepallength的平方'</span>)]</div><div class="line"><span class="keyword">print</span> iris[fields].head(<span class="number">5</span>)</div><div class="line"><span class="keyword">print</span>  (iris.sepallength &lt; <span class="number">5</span>).head(<span class="number">5</span>)</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">#集合类型相关操作。</span></div><div class="line">data = &#123;<span class="string">'id'</span>: [<span class="number">1</span>,<span class="number">2</span>], <span class="string">'a'</span>: [[<span class="string">'a1'</span>,<span class="string">'b1'</span>],[<span class="string">'c1'</span>]], <span class="string">'b'</span>: [&#123;<span class="string">'a2'</span>: <span class="number">0</span>, <span class="string">'b2'</span>: <span class="number">1</span>, <span class="string">'c2'</span>: <span class="number">2</span>&#125;,&#123;<span class="string">'d2'</span>: <span class="number">3</span>, <span class="string">'e2'</span>: <span class="number">4</span>&#125;]&#125;</div><div class="line">df = pd.DataFrame(data)</div><div class="line"><span class="keyword">print</span> df</div><div class="line"></div><div class="line">df1 = DataFrame(df, unknown_as_string=<span class="keyword">True</span>, as_type=&#123;<span class="string">'a'</span>: <span class="string">'list&lt;string&gt;'</span>,<span class="string">'b'</span> : <span class="string">'dict&lt;string,int64&gt;'</span>&#125;)</div><div class="line"><span class="keyword">print</span> df1.dtypes</div><div class="line"><span class="keyword">print</span> df1.head()</div><div class="line"></div><div class="line"><span class="keyword">print</span> df1[df1.id,df1.a[<span class="number">0</span>],df1.b.len()].head()</div><div class="line"><span class="keyword">print</span> df1.a.explode().head()</div><div class="line"><span class="keyword">print</span> df1.a.explode(pos=<span class="keyword">True</span>).head()</div><div class="line"><span class="keyword">print</span> df1.b.explode().head()</div><div class="line"><span class="keyword">print</span> df1.b.explode([<span class="string">'key'</span>,<span class="string">'value'</span>]).head()</div><div class="line"></div><div class="line"><span class="comment">#explode与其他并列多行输出。</span></div><div class="line"><span class="keyword">print</span> df1[df1.id,df1.a.explode()].head()</div><div class="line"></div><div class="line"><span class="comment">#isin,notin,cut。</span></div><div class="line"></div><div class="line"><span class="comment">#isin用于判断Sequence里的元素是否在某个集合元素里；notin反之。</span></div><div class="line"><span class="keyword">print</span> iris.sepallength.isin([<span class="number">4.9</span>,<span class="number">5.1</span>]).rename(<span class="string">'sepallength'</span>).head()</div><div class="line"></div><div class="line"><span class="comment">#cut提供离散化的操作，可以将Sequence的数据拆成几个区段。</span></div><div class="line"><span class="keyword">print</span> iris.sepallength.cut(range(<span class="number">6</span>),labels=[<span class="string">'0-1'</span>,<span class="string">'1-2'</span>,<span class="string">'2-3'</span>,<span class="string">'3-4'</span>,<span class="string">'4-5'</span>]).rename(<span class="string">'sepallength_cut'</span>).head(<span class="number">5</span>)</div><div class="line"></div><div class="line"><span class="comment">#include_under和include_over可以分别包括向下和向上的区间。</span></div><div class="line">labels = [<span class="string">'0-1'</span>, <span class="string">'1-2'</span>, <span class="string">'2-3'</span>, <span class="string">'3-4'</span>, <span class="string">'4-5'</span>, <span class="string">'5-'</span>]</div><div class="line">iris.sepallength.cut(range(<span class="number">6</span>), labels=labels, include_over=<span class="keyword">True</span>).rename(<span class="string">'sepallength_cut'</span>).head(<span class="number">5</span>)</div></pre></td></tr></table></figure>
<h1 id="排序"><a href="#排序" class="headerlink" title="排序"></a>排序</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span>  odps.df <span class="keyword">import</span> DataFrame</div><div class="line"></div><div class="line">iris = DataFrame(o.get_table(<span class="string">'pyodps_iris'</span>))</div><div class="line"></div><div class="line"><span class="comment">#排序</span></div><div class="line"></div><div class="line"><span class="keyword">print</span> iris.sort(<span class="string">'sepalwidth'</span>).head(<span class="number">5</span>)</div><div class="line"></div><div class="line"><span class="comment">#降序排列两种方式</span></div><div class="line"></div><div class="line"><span class="comment">#设置参数ascending=False;进行降序排列</span></div><div class="line"><span class="keyword">print</span> iris.sort(<span class="string">'sepalwidth'</span>,ascending=<span class="keyword">False</span>).head(<span class="number">5</span>)</div><div class="line"></div><div class="line"><span class="comment">#设置-实现降序排列</span></div><div class="line"><span class="keyword">print</span> iris.sort(-iris.sepalwidth).head(<span class="number">5</span>)</div><div class="line"></div><div class="line"><span class="comment">#多字段排序</span></div><div class="line"><span class="keyword">print</span> iris.sort([<span class="string">'sepalwidth'</span>,<span class="string">'petallength'</span>]).head(<span class="number">5</span>)</div><div class="line"></div><div class="line"><span class="comment">#多字段排序时，如果是升序降序不同，ascending参数可以用于传入一个列表，长度必须等同于排序的字段，它们的值都是BOOLEAN类型</span></div><div class="line"><span class="keyword">print</span> iris.sort([<span class="string">'sepalwidth'</span>,<span class="string">'petallength'</span>],ascending=[<span class="keyword">True</span>,<span class="keyword">False</span>]).head(<span class="number">5</span>)</div><div class="line"><span class="keyword">print</span> iris.sort([<span class="string">'sepalwidth'</span>,-iris.petallength]).head(<span class="number">5</span>)</div></pre></td></tr></table></figure>
<h1 id="去重"><a href="#去重" class="headerlink" title="去重"></a>去重</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span>  odps.df <span class="keyword">import</span> DataFrame</div><div class="line"></div><div class="line">iris = DataFrame(o.get_table(<span class="string">'pyodps_iris'</span>))</div><div class="line"></div><div class="line"><span class="keyword">print</span> iris[[<span class="string">'name'</span>]].distinct()</div><div class="line"></div><div class="line"><span class="keyword">print</span> iris.distinct(<span class="string">'name'</span>)</div><div class="line"></div><div class="line"><span class="keyword">print</span> iris.distinct(<span class="string">'name'</span>,<span class="string">'sepallength'</span>).head(<span class="number">3</span>)</div><div class="line"></div><div class="line"><span class="comment">#您可以调用unique对Sequence进行去重操作，但是调用unique的Sequence不能用在列选择中</span></div><div class="line"><span class="keyword">print</span> iris.name.unique()</div></pre></td></tr></table></figure>
<h1 id="采样"><a href="#采样" class="headerlink" title="采样"></a>采样</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#采样</span></div><div class="line"><span class="keyword">from</span>  odps.df <span class="keyword">import</span> DataFrame</div><div class="line">iris = DataFrame(o.get_table(<span class="string">'pyodps_iris'</span>))</div><div class="line"><span class="comment">#按份数采样</span></div><div class="line"><span class="keyword">print</span> iris.sample(parts=<span class="number">10</span>).head(<span class="number">5</span>) <span class="comment">#分为10，分默认取第0份</span></div><div class="line"><span class="keyword">print</span> iris.sample(parts=<span class="number">10</span>,i=<span class="number">0</span>).head(<span class="number">5</span>) <span class="comment">#手动指定取第0份</span></div><div class="line"><span class="keyword">print</span> iris.sample(parts=<span class="number">10</span>,i=[<span class="number">2</span>,<span class="number">5</span>]).head(<span class="number">5</span>)  <span class="comment">#分成10份，取第2和第5份</span></div><div class="line"><span class="keyword">print</span> iris.sample(parts=<span class="number">10</span>,columns=[<span class="string">'name'</span>,<span class="string">'sepalwidth'</span>]).head(<span class="number">5</span>) <span class="comment">#根据name和sepalwidth的值做采样</span></div><div class="line"></div><div class="line"><span class="comment">#按比例、条数采样</span></div><div class="line"><span class="keyword">print</span> iris.sample(n=<span class="number">100</span>).head()  <span class="comment">#选取100条数据</span></div><div class="line"></div><div class="line"><span class="keyword">print</span> iris.sample(frac=<span class="number">0.3</span>).head() <span class="comment">#采样30%的数据</span></div><div class="line"></div><div class="line"><span class="comment">#按权重列采样</span></div><div class="line"><span class="keyword">print</span> iris.sample(n=<span class="number">100</span>,weights=<span class="string">'sepallength'</span>).head()</div><div class="line"></div><div class="line"><span class="keyword">print</span> iris.sample(n=<span class="number">100</span>,weights=<span class="string">'sepalwidth'</span>,replace=<span class="keyword">True</span>).head()</div><div class="line"></div><div class="line"><span class="comment">#分层采样</span></div><div class="line"><span class="keyword">print</span> iris.sample(strata=<span class="string">'name'</span>,n=&#123;<span class="string">'Iris-setosa'</span> : <span class="number">10</span>,<span class="string">'Iris-versicolor'</span> : <span class="number">10</span>&#125;).head()</div><div class="line"><span class="keyword">print</span> iris.sample(strata=<span class="string">'name'</span>,frac=&#123;<span class="string">'Iris-setosa'</span>: <span class="number">0.5</span>,<span class="string">'Iris-versicolor'</span>: <span class="number">0.4</span>&#125;).head()</div></pre></td></tr></table></figure>
<h1 id="数据缩放"><a href="#数据缩放" class="headerlink" title="数据缩放"></a>数据缩放</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">CREATE TABLE `pytable` (</div><div class="line">  `name` string,</div><div class="line">  `id` bigint,</div><div class="line">  `fid` double</div><div class="line">) ;</div><div class="line"></div><div class="line">name1, 4, 5.3</div><div class="line">name2, 2, 3.5</div><div class="line">name2, 3, 1.5</div><div class="line">name1, 4, 4.2</div><div class="line">name1, 3, 2.2</div><div class="line">name1, 3, 4.1</div></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#数据缩放</span></div><div class="line">df = DataFrame(o.get_table(<span class="string">'pytable'</span>))</div><div class="line"></div><div class="line"><span class="comment">#使用min_max_scale方法进行归一化</span></div><div class="line"><span class="keyword">print</span> df.min_max_scale(columns=[<span class="string">'fid'</span>]).head()</div><div class="line"></div><div class="line"><span class="comment">#min_max_scale还支持使用feature_range参数指定输出值的范围。例如，需要使输出值在 (-1, 1) 范围内</span></div><div class="line"><span class="keyword">print</span> df.min_max_scale(columns=[<span class="string">'fid'</span>],feature_range=(<span class="number">-1</span>,<span class="number">1</span>)).head()</div><div class="line"></div><div class="line"><span class="comment">#如果需要保留原始值，可以使用preserve参数。此时，缩放后的数据将会以新增列的形式追加到数据中，列名默认为原列名追加_scaled后缀，该后缀可使用suffix参数更改</span></div><div class="line"><span class="keyword">print</span> df.min_max_scale(columns=[<span class="string">'fid'</span>],preserve=<span class="keyword">True</span>).head()</div><div class="line"></div><div class="line"><span class="comment">#使用group分组</span></div><div class="line"><span class="keyword">print</span> df.min_max_scale(columns=[<span class="string">'fid'</span>],group=[<span class="string">'name'</span>]).head()</div><div class="line"></div><div class="line"><span class="comment">#min_max_scale也支持使用group参数指定一个或多个分组列，在分组列中分别取最值进行缩放</span></div><div class="line"><span class="keyword">print</span> df.std_scale(columns=[<span class="string">'fid'</span>]).head()</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div></pre></td><td class="code"><pre><div class="line">Sql compiled:</div><div class="line">CREATE TABLE tmp_pyodps_59cb5533_6dc3_4b64_9312_b2da29d70cee LIFECYCLE 1 AS</div><div class="line">SELECT /*+mapjoin(t5)*/ t2.`name`, t2.`id`, (IF((t5.`fid_max_1570691133` - t5.`fid_min_1570691133`) == 0, 0, (t2.`fid` - t5.`fid_min_1570691133`) / (t5.`fid_max_1570691133` - t5.`fid_min_1570691133`)) * 1) + 0 AS `fid`</div><div class="line">FROM (</div><div class="line">  SELECT t1.`name`, t1.`id`, t1.`fid`, 1 AS `idx_col_1570691133`</div><div class="line">  FROM WB_BestPractice_dev.`pytable` t1</div><div class="line">) t2</div><div class="line">INNER JOIN</div><div class="line">  (</div><div class="line">    SELECT 1 AS `idx_col_1570691133`, MIN(t4.`fid`) AS `fid_min_1570691133`, MAX(t4.`fid`) AS `fid_max_1570691133`</div><div class="line">    FROM (</div><div class="line">      SELECT t3.`fid`</div><div class="line">      FROM WB_BestPractice_dev.`pytable` t3</div><div class="line">    ) t4</div><div class="line">  ) t5</div><div class="line">ON t2.`idx_col_1570691133` == t5.`idx_col_1570691133`</div><div class="line">Instance ID: 2019101007053495gl8by72m</div><div class="line"></div><div class="line">    name  id       fid</div><div class="line">0  name1   4  1.000000</div><div class="line">1  name2   2  0.526316</div><div class="line">2  name2   3  0.000000</div><div class="line">3  name1   4  0.710526</div><div class="line">4  name1   3  0.184211</div><div class="line">5  name1   3  0.684211</div><div class="line">Sql compiled:</div><div class="line">CREATE TABLE tmp_pyodps_88a24967_3bdc_41ce_85d7_4bbd23e4ce01 LIFECYCLE 1 AS</div><div class="line">SELECT /*+mapjoin(t5)*/ t2.`name`, t2.`id`, (IF((t5.`fid_max_1570691139` - t5.`fid_min_1570691139`) == 0, 0, (t2.`fid` - t5.`fid_min_1570691139`) / (t5.`fid_max_1570691139` - t5.`fid_min_1570691139`)) * 2) + -1 AS `fid`</div><div class="line">FROM (</div><div class="line">  SELECT t1.`name`, t1.`id`, t1.`fid`, 1 AS `idx_col_1570691139`</div><div class="line">  FROM WB_BestPractice_dev.`pytable` t1</div><div class="line">) t2</div><div class="line">INNER JOIN</div><div class="line">  (</div><div class="line">    SELECT 1 AS `idx_col_1570691139`, MIN(t4.`fid`) AS `fid_min_1570691139`, MAX(t4.`fid`) AS `fid_max_1570691139`</div><div class="line">    FROM (</div><div class="line">      SELECT t3.`fid`</div><div class="line">      FROM WB_BestPractice_dev.`pytable` t3</div><div class="line">    ) t4</div><div class="line">  ) t5</div><div class="line">ON t2.`idx_col_1570691139` == t5.`idx_col_1570691139`</div><div class="line">Instance ID: 20191010070539772gjo56292</div><div class="line"></div><div class="line">    name  id       fid</div><div class="line">0  name1   4  1.000000</div><div class="line">1  name2   2  0.052632</div><div class="line">2  name2   3 -1.000000</div><div class="line">3  name1   4  0.421053</div><div class="line">4  name1   3 -0.631579</div><div class="line">5  name1   3  0.368421</div><div class="line">Sql compiled:</div><div class="line">CREATE TABLE tmp_pyodps_439117fc_9ef7_4086_899d_a5bf77d653e5 LIFECYCLE 1 AS</div><div class="line">SELECT /*+mapjoin(t5)*/ t2.`name`, t2.`id`, t2.`fid`, (IF((t5.`fid_max_1570691146` - t5.`fid_min_1570691146`) == 0, 0, (t2.`fid` - t5.`fid_min_1570691146`) / (t5.`fid_max_1570691146` - t5.`fid_min_1570691146`)) * 1) + 0 AS `fid_scaled`</div><div class="line">FROM (</div><div class="line">  SELECT t1.`name`, t1.`id`, t1.`fid`, 1 AS `idx_col_1570691146`</div><div class="line">  FROM WB_BestPractice_dev.`pytable` t1</div><div class="line">) t2</div><div class="line">INNER JOIN</div><div class="line">  (</div><div class="line">    SELECT 1 AS `idx_col_1570691146`, MIN(t4.`fid`) AS `fid_min_1570691146`, MAX(t4.`fid`) AS `fid_max_1570691146`</div><div class="line">    FROM (</div><div class="line">      SELECT t3.`fid`</div><div class="line">      FROM WB_BestPractice_dev.`pytable` t3</div><div class="line">    ) t4</div><div class="line">  ) t5</div><div class="line">ON t2.`idx_col_1570691146` == t5.`idx_col_1570691146`</div><div class="line"></div><div class="line">Instance ID: 20191010070546769g0c14f72</div><div class="line"></div><div class="line">    name  id  fid  fid_scaled</div><div class="line">0  name1   4  5.3    1.000000</div><div class="line">1  name2   2  3.5    0.526316</div><div class="line">2  name2   3  1.5    0.000000</div><div class="line">3  name1   4  4.2    0.710526</div><div class="line">4  name1   3  2.2    0.184211</div><div class="line">5  name1   3  4.1    0.684211</div><div class="line">Sql compiled:</div><div class="line">CREATE TABLE tmp_pyodps_d3839b4b_1087_4d52_91f5_52763b72f272 LIFECYCLE 1 AS</div><div class="line">SELECT /*+mapjoin(t3)*/ t1.`name`, t1.`id`, (IF((t3.`fid_max_1570691151` - t3.`fid_min_1570691151`) == 0, 0, (t1.`fid` - t3.`fid_min_1570691151`) / (t3.`fid_max_1570691151` - t3.`fid_min_1570691151`)) * 1) + 0 AS `fid`</div><div class="line">FROM WB_BestPractice_dev.`pytable` t1</div><div class="line">INNER JOIN</div><div class="line">  (</div><div class="line">    SELECT t2.`name`, MAX(t2.`fid`) AS `fid_max_1570691151`, MIN(t2.`fid`) AS `fid_min_1570691151`</div><div class="line">    FROM WB_BestPractice_dev.`pytable` t2</div><div class="line">    GROUP BY t2.`name`</div><div class="line">  ) t3</div><div class="line">ON t1.`name` == t3.`name`</div><div class="line">Instance ID: 20191010070551756gtf14f72</div><div class="line"></div><div class="line"></div><div class="line">    name  id       fid</div><div class="line">0  name1   4  1.000000</div><div class="line">1  name2   2  1.000000</div><div class="line">2  name2   3  0.000000</div><div class="line">3  name1   4  0.645161</div><div class="line">4  name1   3  0.000000</div><div class="line">5  name1   3  0.612903</div><div class="line">Sql compiled:</div><div class="line">CREATE TABLE tmp_pyodps_1ea6e5b4_129f_4d1e_a6a7_410e08d77ae6 LIFECYCLE 1 AS</div><div class="line">SELECT /*+mapjoin(t5)*/ t2.`name`, t2.`id`, IF(t5.`fid_std_1570691157` == 0, 0, (t2.`fid` - t5.`fid_mean_1570691157`) / t5.`fid_std_1570691157`) AS `fid`</div><div class="line">FROM (</div><div class="line">  SELECT t1.`name`, t1.`id`, t1.`fid`, 1 AS `idx_col_1570691157`</div><div class="line">  FROM WB_BestPractice_dev.`pytable` t1</div><div class="line">) t2</div><div class="line">INNER JOIN</div><div class="line">  (</div><div class="line">    SELECT 1 AS `idx_col_1570691157`, AVG(t4.`fid`) AS `fid_mean_1570691157`, STDDEV(t4.`fid`) AS `fid_std_1570691157`</div><div class="line">    FROM (</div><div class="line">      SELECT t3.`fid`</div><div class="line">      FROM WB_BestPractice_dev.`pytable` t3</div><div class="line">    ) t4</div><div class="line">  ) t5</div><div class="line">ON t2.`idx_col_1570691157` == t5.`idx_col_1570691157`</div><div class="line">Instance ID: 20191010070557788gdl14f72</div><div class="line"></div><div class="line">    name  id       fid</div><div class="line">0  name1   4  1.436467</div><div class="line">1  name2   2  0.026118</div><div class="line">2  name2   3 -1.540938</div><div class="line">3  name1   4  0.574587</div><div class="line">4  name1   3 -0.992468</div><div class="line">5  name1   3  0.496234</div></pre></td></tr></table></figure>
<h1 id="空值处理"><a href="#空值处理" class="headerlink" title="空值处理"></a>空值处理</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">df2 = DataFrame(o.get_table(<span class="string">'pytable2'</span>))</div><div class="line"><span class="comment">#空值处理，dropna,删除包含空值的行</span></div><div class="line"><span class="keyword">print</span> df2.dropna(subset=[<span class="string">'f1'</span>,<span class="string">'f2'</span>,<span class="string">'f3'</span>,<span class="string">'f4'</span>]).head()</div><div class="line"></div><div class="line"><span class="comment">#包含非控制则不删除，可以使用how='all'</span></div><div class="line"></div><div class="line"><span class="keyword">print</span> df2.dropna(how=<span class="string">'all'</span>, subset=[<span class="string">'f1'</span>,<span class="string">'f2'</span>,<span class="string">'f3'</span>,<span class="string">'f4'</span>]).head()</div><div class="line"></div><div class="line"><span class="keyword">print</span> df2.dropna(thresh=<span class="number">3</span>, subset=[<span class="string">'f1'</span>, <span class="string">'f2'</span>, <span class="string">'f3'</span>, <span class="string">'f4'</span>]).head()</div><div class="line"></div><div class="line"><span class="comment">#抵用fillna方法，使用常熟或已有的列来填充未知值</span></div><div class="line"><span class="keyword">print</span> df2.fillna(<span class="number">100</span>, subset=[<span class="string">'f1'</span>,<span class="string">'f2'</span>,<span class="string">'f3'</span>,<span class="string">'f4'</span>]).head()</div><div class="line"></div><div class="line"><span class="comment">#使用一个已有的列填充未知值</span></div><div class="line"><span class="keyword">print</span> df2.fillna(df2.f2, subset=[<span class="string">'f1'</span>,<span class="string">'f2'</span>,<span class="string">'f3'</span>,<span class="string">'f4'</span>]).head()</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">#向前，向后填充</span></div><div class="line"><span class="keyword">print</span> df2.fillna(method=<span class="string">'bfill'</span>, subset=[<span class="string">'f1'</span>, <span class="string">'f2'</span>, <span class="string">'f3'</span>, <span class="string">'f4'</span>]).head()</div><div class="line"></div><div class="line"><span class="comment">#向后填充</span></div><div class="line"><span class="keyword">print</span> df2.fillna(method=<span class="string">'ffill'</span>, subset=[<span class="string">'f1'</span>, <span class="string">'f2'</span>, <span class="string">'f3'</span>, <span class="string">'f4'</span>]).head()</div></pre></td></tr></table></figure>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/xiangyang/tags/阿里云/" rel="tag"># 阿里云</a>
          
            <a href="/xiangyang/tags/Python/" rel="tag"># Python</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/xiangyang/2020/12/06/linux/" rel="next" title="Deepin-使用笔记">
                <i class="fa fa-chevron-left"></i> Deepin-使用笔记
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/xiangyang/2020/12/06/八月碎语/" rel="prev" title="八月碎语">
                八月碎语 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">xiangyang</p>
              <p class="site-description motion-element" itemprop="description">学习笔记</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/xiangyang/archives/">
              
                  <span class="site-state-item-count">17</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/xiangyang/categories/index.html">
                  <span class="site-state-item-count">11</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/xiangyang/tags/index.html">
                  <span class="site-state-item-count">14</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#聚合"><span class="nav-text">聚合</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#条件过滤"><span class="nav-text">条件过滤</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#查看分区"><span class="nav-text">查看分区</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#查看一级分区"><span class="nav-text">查看一级分区</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#sequence操作"><span class="nav-text">sequence操作</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#列运算"><span class="nav-text">列运算</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#排序"><span class="nav-text">排序</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#去重"><span class="nav-text">去重</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#采样"><span class="nav-text">采样</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#数据缩放"><span class="nav-text">数据缩放</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#空值处理"><span class="nav-text">空值处理</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">xiangyang</span>

  
</div>









        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/xiangyang/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/xiangyang/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/xiangyang/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/xiangyang/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/xiangyang/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/xiangyang/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/xiangyang/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/xiangyang/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/xiangyang/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/xiangyang/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/xiangyang/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  

  

</body>
</html>
